<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Analysis</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>

<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-center display-4">Netcreators Loyalty Program &gt Analysis</h1>
            <a href="index.html" class="btn btn-secondary">Back to Upload</a>
        </div>

        <!-- Analysis Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Points Analysis</h5>
                <canvas id="analysisChart" height="100"></canvas>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Summary</h5>
                <ul id="summaryList" class="list-group"></ul>
            </div>
        </div>

        <!-- Firebase Configuration -->
        <script>
            // Transfer CSV data from localStorage
            const storedData = localStorage.getItem('uploadedCSVData');
            const parsedData = storedData ? JSON.parse(storedData) : [];

            if (parsedData.length > 0) {
                analyzeData(parsedData);
            } else {
                document.body.innerHTML = '<div class="container mt-5"><div class="d-flex justify-content-between align-items-center mb-4"><h1 class="text-center display-4">Netcreators Loyalty Program &gt Analysis</h1><a href="index.html" class="btn btn-secondary">Back to Upload</a></div><div class="alert alert-danger">No data available for analysis. Please upload a CSV file first.</div>';
            }

            function analyzeData(data) {
                const groupedData = data.reduce((acc, row) => {
                    const date = row.Date;
                    if (!acc[date]) {
                        acc[date] = { pointsAdded: 0, pointsPaid: 0 };
                    }
                    if (row.Status === "Money Added") {
                        acc[date].pointsAdded += row.Points || 0;
                    } else if (row.Status === "Money Paid") {
                        acc[date].pointsPaid += row.Points || 0;
                    }
                    return acc;
                }, {});

                const labels = Object.keys(groupedData);
                const pointsAddedData = labels.map(date => groupedData[date].pointsAdded);
                const pointsPaidData = labels.map(date => groupedData[date].pointsPaid);

                // Generate Chart
                const ctx = document.getElementById('analysisChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Points Added', data: pointsAddedData, backgroundColor: '#4caf50' },
                            { label: 'Points Paid', data: pointsPaidData, backgroundColor: '#f44336' }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            y: { title: { display: true, text: 'Points' } }
                        }
                    }
                });

                // Generate Summary
                const totalPointsAdded = pointsAddedData.reduce((sum, value) => sum + value, 0);
                const totalPointsPaid = pointsPaidData.reduce((sum, value) => sum + value, 0);
                const summaryList = document.getElementById('summaryList');
                summaryList.innerHTML = `
          <li class="list-group-item">Total Points Added: <strong>${totalPointsAdded}</strong></li>
          <li class="list-group-item">Total Points Paid: <strong>${totalPointsPaid}</strong></li>
          <li class="list-group-item">Number of Transactions: <strong>${data.length}</strong></li>
        `;
            }
        </script>

        <!-- Other Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    </div>
</body>

</html>